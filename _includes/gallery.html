{% assign gallery_path = include.folder %}

{% comment %} Ensure gallery_path is valid {% endcomment %}
{% if gallery_path %}

  {% comment %} Ensure gallery_path starts with / {% endcomment %}
  {% assign first_char = gallery_path | slice: 0 %}
  {% if first_char != '/' %}
    {% assign gallery_path = '/' | append: gallery_path %}
  {% endif %}

  {% comment %} Ensure gallery_path ends with / to match folder exactly {% endcomment %}
  {% assign last_char = gallery_path | slice: -1 %}
  {% if last_char != '/' %}
    {% assign gallery_path = gallery_path | append: '/' %}
  {% endif %}

  <div class="gallery-grid">
    {% assign gallery_images = "" | split: "" %}
    {% for file in site.static_files %}
      {% if file.path contains gallery_path %}
          {% comment %} Double check it starts with the path to avoid partial matches {% endcomment %}
          {% assign file_path_start = file.path | slice: 0, gallery_path.size %}
          {% if file_path_start == gallery_path %}
              {% assign ext = file.extname | downcase %}
              {% if ext == '.jpg' or ext == '.jpeg' or ext == '.png' or ext == '.gif' or ext == '.webp' %}
                  {% assign gallery_images = gallery_images | push: file.path %}
                  <div class="gallery-item" onclick="window.openLightbox('{{ file.path }}')">
                      <img src="{{ file.path }}" alt="{{ file.name }}" loading="lazy">
                  </div>
              {% endif %}
          {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  <script>
    if (typeof window.openLightbox === 'undefined') {
        window.currentImageIndex = 0;
        window.galleryImages = [
            {% for image in gallery_images %}
                "{{ image }}"{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ];

        window.openLightbox = function(imageSrc) {
            var lightbox = document.getElementById('galleryLightbox');
            
            // Update current index based on clicked image
            // We search in the global array which might have grown if multiple galleries exist
            window.currentImageIndex = window.galleryImages.indexOf(imageSrc);

            if (!lightbox) {
                lightbox = document.createElement('div');
                lightbox.id = 'galleryLightbox';
                lightbox.className = 'gallery-lightbox';
                lightbox.innerHTML = `
                    <span class="lightbox-close" onclick="window.closeLightbox()">&times;</span>
                    <a class="lightbox-prev" onclick="window.changeImage(-1)">&#10094;</a>
                    <a class="lightbox-next" onclick="window.changeImage(1)">&#10095;</a>
                    <img class="lightbox-content" id="lightboxImg">
                `;
                document.body.appendChild(lightbox);
                
                lightbox.addEventListener('click', function(e) {
                    if (e.target === lightbox) {
                        window.closeLightbox();
                    }
                });
                
                document.addEventListener('keydown', function(e) {
                    var lb = document.getElementById('galleryLightbox');
                    if (lb && lb.classList.contains('active')) {
                        if (e.key === "Escape") {
                            window.closeLightbox();
                        } else if (e.key === "ArrowLeft") {
                            window.changeImage(-1);
                        } else if (e.key === "ArrowRight") {
                            window.changeImage(1);
                        }
                    }
                });
            }
            
            var img = document.getElementById('lightboxImg');
            img.src = imageSrc;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeLightbox = function() {
            var lightbox = document.getElementById('galleryLightbox');
            if (lightbox) {
                lightbox.classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        window.changeImage = function(n) {
            window.currentImageIndex += n;
            if (window.currentImageIndex >= window.galleryImages.length) {
                window.currentImageIndex = 0;
            } else if (window.currentImageIndex < 0) {
                window.currentImageIndex = window.galleryImages.length - 1;
            }
            var img = document.getElementById('lightboxImg');
            img.src = window.galleryImages[window.currentImageIndex];
        };
    } else {
        // Append new images to the existing global array
        var newImages = [
            {% for image in gallery_images %}
                "{{ image }}"{% unless forloop.last %},{% endunless %}
            {% endfor %}
        ];
        window.galleryImages = window.galleryImages.concat(newImages);
    }
  </script>

{% else %}
  <p style="color: red;">Error: Gallery folder path missing.</p>
{% endif %}
